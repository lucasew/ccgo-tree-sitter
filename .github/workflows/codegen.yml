name: Codegen and Test

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 6' # Weekly on Saturday at midnight
  workflow_dispatch:

jobs:
  codegen:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up tools (mise)
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc

      - name: Run Codegen and Test
        run: uv run test.py

      - name: Codegen
        run: mise run codegen

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update generated grammars"
          title: "Update generated grammars"
          body: "Automated update of tree-sitter grammars generated code."
          branch: "codegen-update"
          delete-branch: true
